{% extends "base.html" %}

{% block title %}{{ title }} | Report App{% endblock %}

{% block content %}
<div class="container">
  <header class="topbar">
    <strong>{{ title }}</strong>
    <a href="{% url 'logout' %}" class="topbar-mobile-logout">繝ｭ繧ｰ繧｢繧ｦ繝・/a>
    <nav>
      <a href="{% url 'report_index' %}">蝣ｱ蜻贋ｸ隕ｧ</a>
      <a href="{% url 'logout' %}" class="logout-link">繝ｭ繧ｰ繧｢繧ｦ繝・/a>
    </nav>
  </header>

  <section class="card" style="margin-top: 16px;">
    <h3>{% if is_edit %}蝣ｱ蜻贋ｿｮ豁｣{% else %}蝣ｱ蜻雁・蜉學% endif %} ({{ dept_name }})</h3>

    {% if submitted %}
    <div class="note" style="margin-top: 10px;">蝣ｱ蜻翫ｒ騾∽ｿ｡縺励∪縺励◆縲・/div>
    {% endif %}

    {% if is_edit %}
    <div class="note" style="margin-top: 10px;">縺薙・逕ｻ髱｢縺ｯ驕主悉繝・・繧ｿ縺ｮ菫ｮ豁｣繝｢繝ｼ繝峨〒縺吶ょ､画峩蠕後↓菫晏ｭ倥＠縺ｦ縺上□縺輔＞縲・/div>
    {% endif %}

    {% if row_errors %}
    <div class="note" style="margin-top: 10px;">
      {% for e in row_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
    </div>
    {% endif %}

    <form method="post" style="margin-top: 12px;" autocomplete="off">
      {% csrf_token %}
      {% if is_edit %}
      <input type="hidden" name="next" value="{{ redirect_target }}">
      {% endif %}

      <div class="grid grid-2">
        <div class="report-date-wrap">
          <label for="{{ form.report_date.id_for_label }}">{{ form.report_date.label }}</label>
          <div class="report-date-field">
            <input
              type="date"
              name="report_date"
              id="id_report_date"
              class="report-date-input"
              value="{{ report_date_value|default:today_iso }}"
              required
            >
          </div>
        </div>
        <div>
          <label for="{{ form.reporter.id_for_label }}">{{ form.reporter.label }}</label>
          <select name="reporter" id="id_reporter">
            <option value="">驕ｸ謚槭＠縺ｦ縺上□縺輔＞</option>
            {% for member in members %}
            <option value="{{ member.id }}" {% if selected_reporter_id == member.id|stringformat:'s' %}selected{% endif %}>{{ member.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <label style="margin-top: 12px;">繝｡繝ｳ繝舌・蛻･蜈･蜉・/label>
      <table class="stacked-card-table">
        <thead>
          <tr>
            <th>繝｡繝ｳ繝舌・</th>
            <th>驥鷹｡・蜀・</th>
            {% if split_counts %}
            <th>CS莉ｶ謨ｰ</th>
            <th>髮｣豌台ｻｶ謨ｰ</th>
            {% else %}
            <th>莉ｶ謨ｰ</th>
            {% endif %}
            {% if show_location %}
            <th>{{ location_label }}</th>
            {% endif %}
          </tr>
        </thead>
        <tbody id="member-rows">
          {% for row in row_values %}
          <tr>
            <td data-label="繝｡繝ｳ繝舌・">
              <select name="member_ids">
                <option value="">驕ｸ謚槭＠縺ｦ縺上□縺輔＞</option>
                {% for member in members %}
                <option value="{{ member.id }}" {% if row.member_id == member.id|stringformat:"s" %}selected{% endif %}>{{ member.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td data-label="驥鷹｡・蜀・"><input type="number" min="0" name="amounts" value="{{ row.amount|default:'0' }}"></td>
            {% if split_counts %}
            <td data-label="CS莉ｶ謨ｰ"><input type="number" min="0" name="cs_counts" value="{{ row.cs_count|default:'0' }}"></td>
            <td data-label="髮｣豌台ｻｶ謨ｰ"><input type="number" min="0" name="refugee_counts" value="{{ row.refugee_count|default:'0' }}"></td>
            {% else %}
            <td data-label="莉ｶ謨ｰ"><input type="number" min="0" name="counts" value="{{ row.count|default:'0' }}"></td>
            {% endif %}
            {% if show_location %}
            <td data-label="{{ location_label }}"><input name="locations" value="{{ row.location }}"></td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div style="margin-top: 10px;">
        <button type="button" id="add-row" class="btn-inline">繝｡繝ｳ繝舌・繧定ｿｽ蜉</button>
      </div>

      {% if not members %}
      <div class="note" style="margin-top: 10px;">
        縺薙・驛ｨ鄂ｲ縺ｫ謇螻槭☆繧九Γ繝ｳ繝舌・縺梧悴逋ｻ骭ｲ縺ｧ縺吶らｮ｡逅・・・繝ｼ繧ｸ縺ｮ繝｡繝ｳ繝舌・險ｭ螳壹°繧画園螻槭Γ繝ｳ繝舌・繧定ｿｽ蜉縺励※縺上□縺輔＞縲・      </div>
      {% endif %}

      <div style="margin-top: 14px;">
        <button type="submit">{% if is_edit %}菫ｮ豁｣縺励※菫晏ｭ・% else %}驛ｨ鄂ｲ蛻・ｒ荳諡ｬ騾∽ｿ｡{% endif %}</button>
      </div>
    </form>
  </section>

  <section class="card" style="margin-top: 16px;">
    <div class="row">
      <h3>騾∽ｿ｡螻･豁ｴ・・{ recent_reports_date }}・・/h3>
      <span class="badge">{{ dept_name }} / {% if selected_mode == "prev" %}蜑肴律蛻・% else %}譛ｬ譌･蛻・% endif %}</span>
    </div>
    <table class="stacked-card-table" style="margin-top: 8px;">
      <thead>
        <tr>
          <th>蝣ｱ蜻頑律</th>
          <th>雋ｬ莉ｻ閠・/th>
          {% if split_counts %}
          <th>CS莉ｶ謨ｰ蜷郁ｨ・/th>
          <th>髮｣豌台ｻｶ謨ｰ蜷郁ｨ・/th>
          {% else %}
          <th>莉ｶ謨ｰ蜷郁ｨ・/th>
          {% endif %}
          <th>驥鷹｡榊粋險・蜀・</th>
          <th>繝｡繝｢</th>
          <th>謫堺ｽ・/th>
        </tr>
      </thead>
      <tbody>
        {% for report in recent_reports %}
        <tr>
          <td data-label="蝣ｱ蜻頑律">{{ report.report_date }}</td>
          <td data-label="雋ｬ莉ｻ閠・>{% if report.reporter %}{{ report.reporter.name }}{% else %}-{% endif %}</td>
          {% if split_counts %}
          <td data-label="CS莉ｶ謨ｰ蜷郁ｨ・>{{ report.cs_count_total|default_if_none:0 }}</td>
          <td data-label="髮｣豌台ｻｶ謨ｰ蜷郁ｨ・>{{ report.refugee_count_total|default_if_none:0 }}</td>
          {% else %}
          <td data-label="莉ｶ謨ｰ蜷郁ｨ・>{{ report.total_count }}</td>
          {% endif %}
          <td data-label="驥鷹｡榊粋險・蜀・">{{ report.followup_count }}</td>
          <td data-label="繝｡繝｢">{{ report.memo|default:"-" }}</td>
          <td data-label="謫堺ｽ・>
            <a href="{% url 'report_edit' report.id %}?next={{ current_view_name }}">
              <button type="button" class="btn-inline">菫ｮ豁｣</button>
            </a>
            <form method="post" action="{% url 'report_delete' dept_code report.id %}" style="display:inline;" onsubmit="return confirm('縺薙・蝣ｱ蜻翫ｒ蜑企勁縺励∪縺吶ゅｈ繧阪＠縺・〒縺吶°・・);">
              {% csrf_token %}
              <button type="submit" class="btn-inline btn-danger">蜑企勁</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="{% if split_counts %}7{% else %}6{% endif %}">譛ｬ譌･縺ｮ騾∽ｿ｡繝・・繧ｿ縺後≠繧翫∪縺帙ｓ縲・/td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<script>
  (function () {
    const reportDateInput = document.getElementById("id_report_date");
    if (reportDateInput && !reportDateInput.value) {
      reportDateInput.value = "{{ today_iso }}";
    }

    const rows = document.getElementById("member-rows");
    const addButton = document.getElementById("add-row");

    if (!rows || !addButton) return;

    addButton.addEventListener("click", function () {
      const firstRow = rows.querySelector("tr");
      if (!firstRow) return;
      const clone = firstRow.cloneNode(true);
      clone.querySelectorAll("select").forEach(function (el) {
        el.selectedIndex = 0;
      });
      clone.querySelectorAll("input").forEach(function (el) {
        if (
          el.name === "amounts" ||
          el.name === "counts" ||
          el.name === "cs_counts" ||
          el.name === "refugee_counts"
        ) {
          el.value = "0";
        } else {
          el.value = "";
        }
      });
      rows.appendChild(clone);
    });
  })();
</script>
{% endblock %}

