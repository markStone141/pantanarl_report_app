{% extends "base.html" %}

{% block title %}{{ title }} | Report App{% endblock %}

{% block content %}
<div class="container">
  <header class="topbar">
    <strong>{{ title }}</strong>
    <nav>
      <a href="{% url 'report_index' %}">報告一覧</a>
      <a href="{% url 'dashboard_index' %}">管理者ページ</a>
      <a href="{% url 'home' %}" class="logout-link">ログアウト</a>
    </nav>
  </header>

  <section class="card" style="margin-top: 16px;">
    <h3>{% if is_edit %}報告修正{% else %}報告入力{% endif %} ({{ dept_code }})</h3>
    <p class="muted">メンバー・金額・件数・{{ location_label }}を行追加しながら入力できます。</p>

    {% if submitted %}
    <div class="note" style="margin-top: 10px;">報告を送信しました。</div>
    {% endif %}

    {% if is_edit %}
    <div class="note" style="margin-top: 10px;">この画面は当日提出分の修正モードです。保存で上書きされます。</div>
    {% endif %}

    {% if row_errors %}
    <div class="note" style="margin-top: 10px;">
      {% for e in row_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
    </div>
    {% endif %}

    <form method="post" style="margin-top: 12px;">
      {% csrf_token %}
      {% if is_edit %}
      <input type="hidden" name="next" value="{{ redirect_target }}">
      {% endif %}

      <div class="grid grid-2">
        <div>
          <label for="{{ form.report_date.id_for_label }}">{{ form.report_date.label }}</label>
          {{ form.report_date }}
        </div>
        <div>
          <label for="{{ form.reporter.id_for_label }}">{{ form.reporter.label }}</label>
          {{ form.reporter }}
        </div>
      </div>

      <label style="margin-top: 12px;">メンバー別入力</label>
      <table>
        <thead>
          <tr>
            <th>メンバー</th>
            <th>金額(円)</th>
            <th>件数</th>
            <th>{{ location_label }}</th>
          </tr>
        </thead>
        <tbody id="member-rows">
          {% for row in row_values %}
          <tr>
            <td>
              <select name="member_ids">
                <option value="">選択してください</option>
                {% for member in members %}
                <option value="{{ member.id }}" {% if row.member_id == member.id|stringformat:"s" %}selected{% endif %}>{{ member.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td><input type="number" min="0" name="amounts" value="{{ row.amount|default:'0' }}" /></td>
            <td><input type="number" min="0" name="counts" value="{{ row.count|default:'0' }}" /></td>
            <td><input name="locations" value="{{ row.location }}" {% if fixed_location %}readonly{% endif %} /></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div style="margin-top: 10px;">
        <button type="button" id="add-row" class="btn-inline">行を追加</button>
      </div>

      {% if not members %}
      <div class="note" style="margin-top: 10px;">
        この部門に所属するメンバーが未設定です。管理者ページのメンバー設定で所属部門を設定してください。
      </div>
      {% endif %}

      <div style="margin-top: 10px;">
        <label for="{{ form.memo.id_for_label }}">{{ form.memo.label }}</label>
        {{ form.memo }}
      </div>

      <div style="margin-top: 14px;">
        <button type="submit">{% if is_edit %}修正を保存{% else %}部署分を一括送信{% endif %}</button>
      </div>
    </form>
  </section>

  <section class="card" style="margin-top: 16px;">
    <div class="row">
      <h3>直近の送信履歴</h3>
      <span class="badge">{{ dept_code }}</span>
    </div>
    <table style="margin-top: 8px;">
      <thead>
        <tr>
          <th>報告日</th>
          <th>責任者</th>
          <th>件数合計</th>
          <th>金額合計(円)</th>
          <th>メモ</th>
        </tr>
      </thead>
      <tbody>
        {% for report in recent_reports %}
        <tr>
          <td>{{ report.report_date }}</td>
          <td>{% if report.reporter %}{{ report.reporter.name }}{% else %}-{% endif %}</td>
          <td>{{ report.total_count }}</td>
          <td>{{ report.followup_count }}</td>
          <td>{{ report.memo|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5">まだ送信データがありません。</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<script>
  (function () {
    const rows = document.getElementById("member-rows");
    const addButton = document.getElementById("add-row");
    const fixedLocation = "{{ fixed_location|escapejs }}";

    if (!rows || !addButton) return;

    addButton.addEventListener("click", function () {
      const firstRow = rows.querySelector("tr");
      if (!firstRow) return;
      const clone = firstRow.cloneNode(true);
      clone.querySelectorAll("select").forEach(function (el) {
        el.selectedIndex = 0;
      });
      clone.querySelectorAll("input").forEach(function (el) {
        if (el.name === "amounts" || el.name === "counts") {
          el.value = "0";
        } else if (el.name === "locations") {
          el.value = fixedLocation;
        } else {
          el.value = "";
        }
      });
      rows.appendChild(clone);
    });
  })();
</script>
{% endblock %}
