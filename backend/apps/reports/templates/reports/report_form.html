{% extends "base.html" %}

{% block title %}{{ title }} | Report App{% endblock %}

{% block content %}
<div class="container">
  <header class="topbar">
    <strong>{{ title }}</strong>
    <nav>
      <a href="{% url 'report_index' %}">報告一覧</a>
      <a href="{% url 'logout' %}" class="logout-link">ログアウト</a>
    </nav>
  </header>

  <section class="card" style="margin-top: 16px;">
    <h3>{% if is_edit %}報告修正{% else %}報告入力{% endif %} ({{ dept_name }})</h3>

    {% if show_location %}
    <p class="muted">メンバー・金額・件数・{{ location_label }}を行追加しながら入力できます。</p>
    {% else %}
    <p class="muted">メンバー・金額・件数を行追加しながら入力できます。{{ location_label }}は不要です。</p>
    {% endif %}

    {% if submitted %}
    <div class="note" style="margin-top: 10px;">報告を送信しました。</div>
    {% endif %}

    {% if is_edit %}
    <div class="note" style="margin-top: 10px;">この画面は当日・過去データの修正モードです。変更後に再保存できます。</div>
    {% endif %}

    {% if row_errors %}
    <div class="note" style="margin-top: 10px;">
      {% for e in row_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
    </div>
    {% endif %}

    <form method="post" style="margin-top: 12px;" autocomplete="off">
      {% csrf_token %}
      {% if is_edit %}
      <input type="hidden" name="next" value="{{ redirect_target }}">
      {% endif %}

      <div class="grid grid-2">
        <div>
          <label for="{{ form.report_date.id_for_label }}">{{ form.report_date.label }}</label>
          {{ form.report_date }}
        </div>
        <div>
          <label for="{{ form.reporter.id_for_label }}">{{ form.reporter.label }}</label>
          <select name="reporter" id="id_reporter">
            <option value="">選択してください</option>
            {% for member in members %}
            <option value="{{ member.id }}" {% if selected_reporter_id == member.id|stringformat:'s' %}selected{% endif %}>{{ member.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <label style="margin-top: 12px;">メンバー別入力</label>
      <table class="mobile-card-table">
        <thead>
          <tr>
            <th>メンバー</th>
            <th>金額(円)</th>
            {% if split_counts %}
            <th>CS件数</th>
            <th>難民件数</th>
            {% else %}
            <th>件数</th>
            {% endif %}
            {% if show_location %}
            <th>{{ location_label }}</th>
            {% endif %}
          </tr>
        </thead>
        <tbody id="member-rows">
          {% for row in row_values %}
          <tr>
            <td data-label="メンバー">
              <select name="member_ids">
                <option value="">選択してください</option>
                {% for member in members %}
                <option value="{{ member.id }}" {% if row.member_id == member.id|stringformat:"s" %}selected{% endif %}>{{ member.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td data-label="金額(円)"><input type="number" min="0" name="amounts" value="{{ row.amount|default:'0' }}"></td>
            {% if split_counts %}
            <td data-label="CS件数"><input type="number" min="0" name="cs_counts" value="{{ row.cs_count|default:'0' }}"></td>
            <td data-label="難民件数"><input type="number" min="0" name="refugee_counts" value="{{ row.refugee_count|default:'0' }}"></td>
            {% else %}
            <td data-label="件数"><input type="number" min="0" name="counts" value="{{ row.count|default:'0' }}"></td>
            {% endif %}
            {% if show_location %}
            <td data-label="{{ location_label }}"><input name="locations" value="{{ row.location }}"></td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div style="margin-top: 10px;">
        <button type="button" id="add-row" class="btn-inline">行を追加</button>
      </div>

      {% if not members %}
      <div class="note" style="margin-top: 10px;">
        この部門に所属するメンバーが未登録です。管理ページのメンバー設定で所属部門を設定してください。
      </div>
      {% endif %}

      <div style="margin-top: 10px;">
        <label for="{{ form.memo.id_for_label }}">{{ form.memo.label }}</label>
        <textarea name="memo" rows="3" id="id_memo">{{ memo_value }}</textarea>
      </div>

      <div style="margin-top: 14px;">
        <button type="submit">{% if is_edit %}修正して保存{% else %}部門分を一括送信{% endif %}</button>
      </div>
    </form>
  </section>

  <section class="card" style="margin-top: 16px;">
    <div class="row">
      <h3>直近の送信履歴</h3>
      <span class="badge">{{ dept_name }}</span>
    </div>
    <table class="mobile-card-table" style="margin-top: 8px;">
      <thead>
        <tr>
          <th>報告日</th>
          <th>責任者</th>
          {% if split_counts %}
          <th>CS件数合計</th>
          <th>難民件数合計</th>
          {% else %}
          <th>件数合計</th>
          {% endif %}
          <th>金額合計(円)</th>
          <th>メモ</th>
        </tr>
      </thead>
      <tbody>
        {% for report in recent_reports %}
        <tr>
          <td data-label="報告日">{{ report.report_date }}</td>
          <td data-label="責任者">{% if report.reporter %}{{ report.reporter.name }}{% else %}-{% endif %}</td>
          {% if split_counts %}
          <td data-label="CS件数合計">{{ report.cs_count_total|default_if_none:0 }}</td>
          <td data-label="難民件数合計">{{ report.refugee_count_total|default_if_none:0 }}</td>
          {% else %}
          <td data-label="件数合計">{{ report.total_count }}</td>
          {% endif %}
          <td data-label="金額合計(円)">{{ report.followup_count }}</td>
          <td data-label="メモ">{{ report.memo|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="{% if split_counts %}6{% else %}5{% endif %}">まだ送信データがありません。</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<script>
  (function () {
    const rows = document.getElementById("member-rows");
    const addButton = document.getElementById("add-row");

    if (!rows || !addButton) return;

    addButton.addEventListener("click", function () {
      const firstRow = rows.querySelector("tr");
      if (!firstRow) return;
      const clone = firstRow.cloneNode(true);
      clone.querySelectorAll("select").forEach(function (el) {
        el.selectedIndex = 0;
      });
      clone.querySelectorAll("input").forEach(function (el) {
        if (
          el.name === "amounts" ||
          el.name === "counts" ||
          el.name === "cs_counts" ||
          el.name === "refugee_counts"
        ) {
          el.value = "0";
        } else {
          el.value = "";
        }
      });
      rows.appendChild(clone);
    });
  })();
</script>
{% endblock %}
