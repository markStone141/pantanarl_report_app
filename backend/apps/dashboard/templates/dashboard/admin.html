{% extends "base.html" %}

{% block title %}管理者ページ | Report App{% endblock %}

{% block content %}
<div class="container">
  <header class="topbar">
    <div>
      <strong>管理者ページ</strong>
      <div class="muted" style="color: #e1f1f5;">提出状況、部門別実績、目標進捗を確認できます。</div>
    </div>
    <nav>
      <a href="{% url 'dashboard_index' %}">ダッシュボード</a>
      <a href="{% url 'member_settings' %}">メンバー管理</a>
      <a href="{% url 'department_settings' %}">部署管理</a>
      <a href="{% url 'target_index' %}">目標設定</a>
      <a href="{% url 'report_history' %}">保存報告一覧</a>
      <a href="{% url 'logout' %}" class="logout-link">ログアウト</a>
    </nav>
  </header>

  <section class="card" style="margin-top: 16px;">
    <div class="row">
      <h3>提出状況一覧</h3>
      <span class="badge">対象日: {{ today_str }}</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>部署</th>
          <th>担当者</th>
          <th>提出時刻</th>
          <th>ステータス</th>
          <th>件数</th>
          <th>件数内訳</th>
          <th>金額</th>
          <th>修正</th>
        </tr>
      </thead>
      <tbody>
        {% for row in submission_rows %}
        <tr>
          <td>{{ row.label }}</td>
          <td>{{ row.reporter_name }}</td>
          <td>{{ row.submitted_time }}</td>
          <td><span class="badge">{{ row.status }}</span></td>
          <td>{{ row.count }}</td>
          <td>{% if row.has_split_counts %}CS {{ row.cs_count }} / 難民 {{ row.refugee_count }}{% else %}-{% endif %}</td>
          <td>{{ row.amount }}</td>
          <td>
            {% if row.report_id %}
            <a href="{% url 'report_edit' row.report_id %}"><button type="button" class="btn-inline">修正</button></a>
            {% else %}
            -
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <section class="card" style="margin-top: 16px;">
    <div class="row">
      <h3>本日の部門別実績</h3>
    </div>
    <div class="grid grid-3" style="margin-top: 12px;">
      {% for card in kpi_cards %}
      <article class="card">
        <h3>{{ card.title }}</h3>
        <div class="kpi">¥ {{ card.amount }}</div>
        {% if card.has_split_counts %}
        <p class="muted">CS {{ card.cs_count }} / 難民 {{ card.refugee_count }}</p>
        {% else %}
        <p class="muted">{{ card.count }} 件</p>
        {% endif %}
        <label style="margin-top: 8px;">個人成績</label>
        <table>
          <thead>
            {% if card.has_split_counts %}
            <tr><th>メンバー</th><th>CS</th><th>難民</th><th>金額</th></tr>
            {% else %}
            <tr><th>メンバー</th><th>件数</th><th>金額</th></tr>
            {% endif %}
          </thead>
          <tbody>
            {% for row in card.members %}
            <tr>
              <td>{{ row.member_name }}</td>
              {% if card.has_split_counts %}
              <td>{{ row.cs_count }}</td>
              <td>{{ row.refugee_count }}</td>
              {% else %}
              <td>{{ row.count }}</td>
              {% endif %}
              <td>{{ row.amount }}</td>
            </tr>
            {% empty %}
            {% if card.has_split_counts %}
            <tr><td>-</td><td>-</td><td>-</td><td>-</td></tr>
            {% else %}
            <tr><td>-</td><td>-</td><td>-</td></tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </article>
      {% endfor %}
    </div>
  </section>

  <section style="margin-top: 16px; display: grid; gap: 16px;">
    <article class="card">
      <h3>日次まとめメール</h3>
      <p class="muted">テンプレートを生成してコピーできます。</p>
      <button type="button" id="build-mail">テンプレート生成</button>
      <label for="mail-comment">コメント</label>
      <textarea id="mail-comment" placeholder="コメントを入力"></textarea>
      <label for="mail-body">メール本文（コピー用）</label>
      <textarea id="mail-body" placeholder="ここに本文が出力されます"></textarea>
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <button type="button" id="preview-mail">全文プレビュー</button>
        <button type="button" id="copy-mail">本文をコピー</button>
      </div>
    </article>

    <article class="card">
      <h3>目標管理</h3>
      <p class="muted">対象月: {{ target_month_summary }} [{{ target_month_status }}] / 現在路程: {{ target_period_summary }} [{{ target_period_status }}]</p>

      <h4 style="margin: 12px 0 8px;">月目標</h4>
      <table>
        <thead>
          <tr>
            <th>部署</th>
            <th>月目標</th>
            <th>月累計実績</th>
            <th>達成率</th>
          </tr>
        </thead>
        <tbody>
          {% for row in target_progress_rows %}
          <tr>
            <td>{{ row.label }}</td>
            <td>{{ row.month_target }}</td>
            <td>{{ row.month_actual }}</td>
            <td>{{ row.month_rate }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4">目標データがありません。</td></tr>
          {% endfor %}
        </tbody>
      </table>

      <h4 style="margin: 16px 0 8px;">路程目標</h4>
      <table>
        <thead>
          <tr>
            <th>部署</th>
            <th>路程目標</th>
            <th>路程累計実績</th>
            <th>達成率</th>
          </tr>
        </thead>
        <tbody>
          {% for row in target_progress_rows %}
          <tr>
            <td>{{ row.label }}</td>
            <td>{{ row.period_target }}</td>
            <td>{{ row.period_actual }}</td>
            <td>{{ row.period_rate }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4">目標データがありません。</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </article>
  </section>
</div>

<div id="mail-preview-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 9999; padding: 24px;">
  <div style="background: #fff; width: min(960px, 96vw); height: min(90vh, 900px); margin: 0 auto; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #dde6eb;">
      <strong>メール本文プレビュー</strong>
      <div style="display: flex; gap: 8px;">
        <button type="button" id="copy-mail-preview" class="btn-inline">コピー</button>
        <button type="button" id="close-mail-preview" class="btn-inline">閉じる</button>
      </div>
    </div>
    <div style="padding: 12px 16px; overflow: auto; flex: 1;">
      <pre id="mail-preview-content" style="margin: 0; white-space: pre-wrap; word-break: break-word; font-family: Meiryo, sans-serif; font-size: 14px; line-height: 1.6;"></pre>
    </div>
  </div>
</div>

{{ mail_template_payload|json_script:"mail-template-data" }}
<script>
  (function () {
    function buildSectionLines(section, periodName, periodRange) {
      const lines = [];
      const amountLabel = section.code && section.code.indexOf("STYLE") === 0 ? "金額" : "支援額";
      lines.push(section.heading + "（" + section.name + "）");
      lines.push("全体");
      lines.push("件数" + section.daily_count + "件、" + amountLabel + section.daily_amount_text);
      lines.push("");
      if (section.member_lines.length) {
        section.member_lines.forEach(function (row) {
          lines.push(row.name);
          lines.push("件数" + row.count + "件、" + amountLabel + row.amount_text);
        });
      } else {
        lines.push("個人成績データなし");
      }
      lines.push("");
      lines.push("【" + periodName + "（" + periodRange + "）】");
      if (section.period_lines.length) {
        section.period_lines.forEach(function (line) {
          lines.push(line);
        });
      } else {
        lines.push("路程目標データなし");
      }
      lines.push("【月間目標達成率】");
      if (section.month_lines.length) {
        section.month_lines.forEach(function (line) {
          lines.push(line);
        });
      } else {
        lines.push("月目標データなし");
      }
      return lines;
    }

    function buildMailBody(payload, commentValue) {
      const lines = [];
      payload.sections.forEach(function (section, idx) {
        buildSectionLines(section, payload.period_name, payload.period_range).forEach(function (line) {
          lines.push(line);
        });
        if (idx !== payload.sections.length - 1) lines.push("");
      });
      lines.push("");
      lines.push("UN全体 " + payload.un_wv_summary.actual_text + "/" + payload.un_wv_summary.target_text + " 達成率" + payload.un_wv_summary.rate);
      lines.push("");
      lines.push("コメント");
      lines.push((commentValue || "").trim() || "（コメント未入力）");
      return lines.join("\n");
    }

    const payloadEl = document.getElementById("mail-template-data");
    const payload = payloadEl ? JSON.parse(payloadEl.textContent) : null;
    const buildBtn = document.getElementById("build-mail");
    const previewBtn = document.getElementById("preview-mail");
    const copyBtn = document.getElementById("copy-mail");
    const commentEl = document.getElementById("mail-comment");
    const bodyEl = document.getElementById("mail-body");
    const modalEl = document.getElementById("mail-preview-modal");
    const closeModalBtn = document.getElementById("close-mail-preview");
    const copyPreviewBtn = document.getElementById("copy-mail-preview");
    const previewContent = document.getElementById("mail-preview-content");
    if (!payload || !buildBtn || !previewBtn || !copyBtn || !commentEl || !bodyEl || !modalEl || !closeModalBtn || !copyPreviewBtn || !previewContent) return;

    function openPreview() {
      if (!bodyEl.value.trim()) {
        alert("先にテンプレートを生成してください。");
        return;
      }
      previewContent.textContent = bodyEl.value;
      modalEl.style.display = "block";
    }

    function closePreview() {
      modalEl.style.display = "none";
    }

    buildBtn.addEventListener("click", function () {
      bodyEl.value = buildMailBody(payload, commentEl.value);
      openPreview();
    });

    previewBtn.addEventListener("click", openPreview);
    closeModalBtn.addEventListener("click", closePreview);
    copyPreviewBtn.addEventListener("click", async function () {
      if (!bodyEl.value.trim()) return;
      try {
        await navigator.clipboard.writeText(bodyEl.value);
        alert("本文をコピーしました。");
      } catch (e) {
        bodyEl.select();
        document.execCommand("copy");
        alert("本文をコピーしました。");
      }
    });
    modalEl.addEventListener("click", function (e) {
      if (e.target === modalEl) closePreview();
    });

    copyBtn.addEventListener("click", async function () {
      if (!bodyEl.value.trim()) {
        alert("先にテンプレートを生成してください。");
        return;
      }
      try {
        await navigator.clipboard.writeText(bodyEl.value);
        alert("本文をコピーしました。");
      } catch (e) {
        bodyEl.select();
        document.execCommand("copy");
        alert("本文をコピーしました。");
      }
    });
  })();
</script>
{% endblock %}
