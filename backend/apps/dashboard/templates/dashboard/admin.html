{% extends "base.html" %}

{% block title %}管理者ページ | Report App{% endblock %}

{% block content %}
<div class="container">
  <header class="topbar">
    <div>
      <strong>管理者ページ</strong>
    </div>
    <nav>
      <a href="{% url 'dashboard_index' %}">ダッシュボード</a>
      <a href="{% url 'member_settings' %}">メンバー管理</a>
      <a href="{% url 'department_settings' %}">部署管理</a>
      <a href="{% url 'target_index' %}">目標設定</a>
      <a href="{% url 'report_history' %}">保存報告一覧</a>
      <a href="{% url 'logout' %}" class="logout-link">ログアウト</a>
    </nav>
  </header>

  <section class="card" style="margin-top: 16px;">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
      <a href="{% url 'dashboard_index' %}?mode=today" class="department-button" style="width:auto; {% if selected_mode == 'today' %}{% else %}background:#fff; color:var(--brand); border:1px solid var(--brand);{% endif %}">本日表示</a>
      <a href="{% url 'dashboard_index' %}?mode=prev" class="department-button" style="width:auto; {% if selected_mode == 'prev' %}{% else %}background:#fff; color:var(--brand); border:1px solid var(--brand);{% endif %}">前日表示</a>
      <span class="badge">表示日: {{ today_str }}</span>
    </div>
  </section>

  <section class="card" style="margin-top: 16px;">
    <h3>メール本文作成</h3>
    <div style="display:flex; gap:8px; margin-top: 8px; align-items: center; flex-wrap: wrap;">
      <button type="button" id="mail-mode-today" class="btn-inline">本日</button>
      <button type="button" id="mail-mode-prev" class="btn-inline">前日</button>
      <span class="badge" id="mail-source-date"></span>
    </div>
    <textarea id="mail-comment" placeholder="コメントを入力"></textarea>
    <button type="button" id="build-mail" style="margin-top: 10px;">テンプレート生成</button>
  </section>

  <section class="card" style="margin-top: 16px;">
    <div class="row">
      <h3>提出状況一覧</h3>
      <span class="badge">対象日: {{ today_str }}</span>
    </div>
    <table class="mobile-card-table">
      <thead>
        <tr>
          <th>部署</th>
          <th>担当者</th>
          <th>提出時刻</th>
          <th>ステータス</th>
          <th>件数</th>
          <th>件数内訳</th>
          <th>金額</th>
          <th>修正</th>
        </tr>
      </thead>
      <tbody>
        {% for row in submission_rows %}
        <tr>
          <td data-label="部署">{{ row.label }}</td>
          <td data-label="担当者">{{ row.reporter_name }}</td>
          <td data-label="提出時刻">{{ row.submitted_time }}</td>
          <td data-label="ステータス"><span class="badge">{{ row.status }}</span></td>
          <td data-label="件数">{{ row.count }}</td>
          <td data-label="件数内訳">{% if row.has_split_counts %}CS {{ row.cs_count }} / 難民 {{ row.refugee_count }}{% else %}-{% endif %}</td>
          <td data-label="金額">{{ row.amount }}</td>
          <td data-label="修正">
            {% if row.report_id %}
            <a href="{% url 'report_edit' row.report_id %}"><button type="button" class="btn-inline">修正</button></a>
            {% else %}
            -
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <section class="card" style="margin-top: 16px;">
    <div class="row">
      <h3>本日の部門別実績</h3>
    </div>
    <div class="grid grid-3" style="margin-top: 12px;">
      {% for card in kpi_cards %}
      <article class="card">
        <h3>{{ card.title }}</h3>
        <div class="kpi">¥ {{ card.amount }}</div>
        {% if card.has_split_counts %}
        <p class="muted">CS {{ card.cs_count }} / 難民 {{ card.refugee_count }}</p>
        {% else %}
        <p class="muted">{{ card.count }} 件</p>
        {% endif %}
        <details class="mobile-only-accordion" style="margin-top: 8px;">
          <summary style="cursor: pointer;">個人成績を表示</summary>
          <table style="margin-top: 8px;">
            <thead>
              {% if card.has_split_counts %}
              <tr><th>メンバー</th><th>CS</th><th>難民</th><th>金額</th></tr>
              {% else %}
              <tr><th>メンバー</th><th>件数</th><th>金額</th></tr>
              {% endif %}
            </thead>
            <tbody>
              {% for row in card.members %}
              <tr>
                <td>{{ row.member_name }}</td>
                {% if card.has_split_counts %}
                <td>{{ row.cs_count }}</td>
                <td>{{ row.refugee_count }}</td>
                {% else %}
                <td>{{ row.count }}</td>
                {% endif %}
                <td>{{ row.amount }}</td>
              </tr>
              {% empty %}
              {% if card.has_split_counts %}
              <tr><td>-</td><td>-</td><td>-</td><td>-</td></tr>
              {% else %}
              <tr><td>-</td><td>-</td><td>-</td></tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </details>
      </article>
      {% endfor %}
    </div>
  </section>

  <section style="margin-top: 16px; display: grid; gap: 16px;">
    <article class="card">
      <h3>目標管理</h3>
      <p class="muted">対象月: {{ target_month_summary }} [{{ target_month_status }}] / 現在路程: {{ target_period_summary }} [{{ target_period_status }}]</p>

      <details class="mobile-only-accordion" style="margin-top: 10px;">
        <summary style="cursor: pointer;">月目標（詳細）</summary>
        <table style="margin-top: 8px;">
          <thead>
            <tr>
              <th>部署</th>
              <th>月目標</th>
              <th>月累計実績</th>
              <th>達成率</th>
            </tr>
          </thead>
          <tbody>
            {% for row in target_progress_rows %}
            <tr>
              <td>{{ row.label }}</td>
              <td>{{ row.month_target }}</td>
              <td>{{ row.month_actual }}</td>
              <td>{{ row.month_rate }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4">目標データがありません。</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </details>

      <h4 style="margin: 16px 0 8px;">路程目標</h4>
      <details class="mobile-only-accordion" style="margin-top: 10px;">
        <summary style="cursor: pointer;">路程目標（詳細）</summary>
        <table style="margin-top: 8px;">
          <thead>
            <tr>
              <th>部署</th>
              <th>路程目標</th>
              <th>路程累計実績</th>
              <th>達成率</th>
            </tr>
          </thead>
          <tbody>
            {% for row in target_progress_rows %}
            <tr>
              <td>{{ row.label }}</td>
              <td>{{ row.period_target }}</td>
              <td>{{ row.period_actual }}</td>
              <td>{{ row.period_rate }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4">目標データがありません。</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </details>
    </article>
  </section>
</div>

<div id="mail-preview-modal" class="modal-overlay" style="display: none;">
  <div class="modal-panel">
    <div class="modal-header">
      <strong>メール本文プレビュー</strong>
      <div class="modal-actions">
        <button type="button" id="copy-mail-preview" class="btn-inline">コピー</button>
        <button type="button" id="close-mail-preview" class="btn-inline">閉じる</button>
      </div>
    </div>
    <div class="modal-body">
      <pre id="mail-preview-content" class="modal-pre"></pre>
    </div>
  </div>
</div>

{{ mail_template_payload_map|json_script:"mail-template-data-map" }}
<script>
  (function () {
    function buildSectionLines(section, periodName, periodRange) {
      const lines = [];
      const amountLabel = section.code && section.code.indexOf("STYLE") === 0 ? "金額" : "支援額";
      lines.push(section.heading + "（" + section.name + "）");
      lines.push("全体");
      lines.push("件数" + section.daily_count + "件、" + amountLabel + section.daily_amount_text);
      lines.push("");
      if (section.member_lines.length) {
        section.member_lines.forEach(function (row) {
          lines.push(row.name);
          lines.push("件数" + row.count + "件、" + amountLabel + row.amount_text);
        });
      } else {
        lines.push("個人成績データなし");
      }
      lines.push("");
      lines.push("【" + periodName + "（" + periodRange + "）】");
      if (section.period_lines.length) {
        section.period_lines.forEach(function (line) {
          lines.push(line);
        });
      } else {
        lines.push("路程目標データなし");
      }
      lines.push("【月間目標達成率】");
      if (section.month_lines.length) {
        section.month_lines.forEach(function (line) {
          lines.push(line);
        });
      } else {
        lines.push("月目標データなし");
      }
      return lines;
    }

    function buildMailBody(payload, commentValue) {
      const lines = [];
      payload.sections.forEach(function (section, idx) {
        buildSectionLines(section, payload.period_name, payload.period_range).forEach(function (line) {
          lines.push(line);
        });
        if (idx !== payload.sections.length - 1) lines.push("");
      });
      lines.push("");
      lines.push("UN全体 " + payload.un_wv_summary.actual_text + "/" + payload.un_wv_summary.target_text + " 達成率" + payload.un_wv_summary.rate);
      lines.push("");
      lines.push("コメント");
      lines.push((commentValue || "").trim() || "（コメント未入力）");
      return lines.join("\n");
    }

    function buildSectionLinesV2(section, periodName, periodRange) {
      const lines = [];
      const amountLabel = section.code && section.code.indexOf("STYLE") === 0 ? "金額" : "支援額";
      lines.push(section.heading + "（" + section.name + "）");

      if (section.has_report) {
        lines.push("全体");
        lines.push("件数" + section.daily_count + "件、" + amountLabel + section.daily_amount_text);
        lines.push("");
        if (section.member_lines.length) {
          section.member_lines.forEach(function (row) {
            lines.push(row.name);
            lines.push("件数" + row.count + "件、" + amountLabel + row.amount_text);
          });
        } else {
          lines.push("個人実績データなし");
        }
        lines.push("");
      } else {
        lines.push("稼働無し");
        lines.push("");
      }

      lines.push("【" + periodName + "（" + periodRange + "）】");
      if (section.period_lines.length) {
        section.period_lines.forEach(function (line) {
          lines.push(line);
        });
      } else {
        lines.push("路程目標データなし");
      }
      lines.push("【月間目標達成率】");
      if (section.month_lines.length) {
        section.month_lines.forEach(function (line) {
          lines.push(line);
        });
      } else {
        lines.push("月目標データなし");
      }
      return lines;
    }

    function buildMailBodyV2(payload, commentValue) {
      const lines = [];
      let insertedUnSummary = false;

      payload.sections.forEach(function (section, idx) {
        buildSectionLinesV2(section, payload.period_name, payload.period_range).forEach(function (line) {
          lines.push(line);
        });

        if (section.code === "WV") {
          lines.push("");
          lines.push("UN全体 " + payload.un_wv_summary.actual_text + "/" + payload.un_wv_summary.target_text + " 達成率" + payload.un_wv_summary.rate);
          lines.push("");
          insertedUnSummary = true;
        } else if (idx !== payload.sections.length - 1) {
          lines.push("");
        }
      });

      if (!insertedUnSummary) {
        lines.push("");
        lines.push("UN全体 " + payload.un_wv_summary.actual_text + "/" + payload.un_wv_summary.target_text + " 達成率" + payload.un_wv_summary.rate);
      }

      lines.push("");
      lines.push((commentValue || "").trim() || "（コメント未入力）");
      return lines.join("\n");
    }

    const payloadMapEl = document.getElementById("mail-template-data-map");
    const payloadMap = payloadMapEl ? JSON.parse(payloadMapEl.textContent) : null;
    const buildBtn = document.getElementById("build-mail");
    const modeTodayBtn = document.getElementById("mail-mode-today");
    const modePrevBtn = document.getElementById("mail-mode-prev");
    const sourceDateEl = document.getElementById("mail-source-date");
    const commentEl = document.getElementById("mail-comment");
    const modalEl = document.getElementById("mail-preview-modal");
    const closeModalBtn = document.getElementById("close-mail-preview");
    const copyPreviewBtn = document.getElementById("copy-mail-preview");
    const previewContent = document.getElementById("mail-preview-content");
    if (
      !payloadMap ||
      !buildBtn ||
      !commentEl ||
      !modalEl ||
      !closeModalBtn ||
      !copyPreviewBtn ||
      !previewContent ||
      !modeTodayBtn ||
      !modePrevBtn ||
      !sourceDateEl
    ) return;

    let generatedBody = "";
    let selectedMode = "{{ selected_mode|default:'today' }}" === "prev" ? "prev" : "today";

    function getPayload() {
      return payloadMap[selectedMode] || payloadMap.today || payloadMap.prev || null;
    }

    function syncModeUI() {
      modeTodayBtn.style.opacity = selectedMode === "today" ? "1" : ".65";
      modePrevBtn.style.opacity = selectedMode === "prev" ? "1" : ".65";
      const payload = getPayload();
      sourceDateEl.textContent = payload ? ("参照日: " + payload.report_date) : "";
    }

    function openPreview() {
      if (!generatedBody.trim()) {
        alert("先にテンプレートを生成してください。");
        return;
      }
      previewContent.textContent = generatedBody;
      modalEl.style.display = "block";
    }

    function closePreview() {
      modalEl.style.display = "none";
    }

    modeTodayBtn.addEventListener("click", function () {
      selectedMode = "today";
      syncModeUI();
    });
    modePrevBtn.addEventListener("click", function () {
      selectedMode = "prev";
      syncModeUI();
    });

    buildBtn.addEventListener("click", function () {
      const payload = getPayload();
      if (!payload) {
        alert("テンプレートデータを読み込めません。");
        return;
      }
      generatedBody = buildMailBodyV2(payload, commentEl.value);
      openPreview();
    });

    closeModalBtn.addEventListener("click", closePreview);
    copyPreviewBtn.addEventListener("click", async function () {
      if (!generatedBody.trim()) return;
      try {
        await navigator.clipboard.writeText(generatedBody);
        alert("本文をコピーしました。");
      } catch (e) {
        const tmp = document.createElement("textarea");
        tmp.value = generatedBody;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand("copy");
        tmp.remove();
        alert("本文をコピーしました。");
      }
    });
    modalEl.addEventListener("click", function (e) {
      if (e.target === modalEl) closePreview();
    });

    syncModeUI();
  })();

  (function () {
    const detailsEls = document.querySelectorAll("details.mobile-only-accordion");
    if (!detailsEls.length) return;
    const mq = window.matchMedia("(max-width: 768px)");

    function syncAccordionMode() {
      const mobile = mq.matches;
      detailsEls.forEach(function (detailsEl) {
        const summaryEl = detailsEl.querySelector("summary");
        if (!summaryEl) return;
        if (mobile) {
          summaryEl.style.display = "";
          if (!detailsEl.dataset.userToggled) {
            detailsEl.open = false;
          }
        } else {
          detailsEl.open = true;
          summaryEl.style.display = "none";
        }
      });
    }

    detailsEls.forEach(function (detailsEl) {
      detailsEl.addEventListener("toggle", function () {
        detailsEl.dataset.userToggled = "1";
      });
    });

    syncAccordionMode();
    if (mq.addEventListener) {
      mq.addEventListener("change", syncAccordionMode);
    } else if (mq.addListener) {
      mq.addListener(syncAccordionMode);
    }
    window.addEventListener("resize", syncAccordionMode);
  })();
</script>
{% endblock %}
