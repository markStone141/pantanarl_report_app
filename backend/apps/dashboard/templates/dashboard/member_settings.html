{% extends "base.html" %}

{% block title %}メンバー管理 | Report App{% endblock %}

{% block content %}
<div class="container">
  <header class="topbar">
    <div>
      <strong>メンバー管理</strong>
      <div class="muted" style="color: #e1f1f5;">名前と所属部署を管理します。</div>
    </div>
    <nav>
      <a href="{% url 'dashboard_index' %}">管理者ページ</a>
      <a href="{% url 'department_settings' %}">部署管理</a>
      <a href="{% url 'logout' %}" class="logout-link">ログアウト</a>
    </nav>
  </header>

  <section class="grid grid-2" style="margin-top: 16px;">
    <article class="card">
      <h3>{% if edit_member %}メンバー編集{% else %}新規メンバー登録{% endif %}</h3>
      <form method="post">
        {% csrf_token %}
        {% if edit_member %}
        <input type="hidden" name="edit_member_id" value="{{ edit_member.id }}" />
        {% endif %}

        <label for="id_name">{{ form.name.label }}</label>
        {{ form.name }}
        {% if form.name.errors %}
        <div class="error-text">{{ form.name.errors|striptags }}</div>
        {% endif %}

        <label>{{ form.departments.label }}</label>
        <div id="department_choices" class="checkbox-list">
          {% for department in department_choices %}
          <div class="checkbox-row">
            <label class="checkbox-label" for="dept_choice_{{ department.id }}">
              <input
                class="checkbox-input"
                type="checkbox"
                name="departments"
                value="{{ department.id }}"
                id="dept_choice_{{ department.id }}"
                {% if department.id|stringformat:"s" in selected_department_ids %}checked{% endif %}
              />
              {{ department.name }} ({{ department.code }})
            </label>
          </div>
          {% empty %}
          <div class="muted">有効な部署がありません。</div>
          {% endfor %}
        </div>
        {% if form.departments.errors %}
        <div class="error-text">{{ form.departments.errors|striptags }}</div>
        {% endif %}

        <button type="submit" style="margin-top: 12px;">
          {% if edit_member %}メンバーを更新{% else %}メンバーを登録{% endif %}
        </button>
        {% if edit_member %}
        <a href="{% url 'member_settings' %}" style="display:block;margin-top:8px;">編集をキャンセル</a>
        {% endif %}
      </form>
    </article>

    <article class="card">
      <h3>現在のメンバー</h3>
      {% if status_message %}
      <div class="note" style="margin-bottom: 10px;">
        {{ status_message }}
      </div>
      {% endif %}

      {% if members %}
      <table>
        <thead>
          <tr><th>名前</th><th>所属部署</th><th>登録日時</th><th>操作</th></tr>
        </thead>
        <tbody>
          {% for member in members %}
          <tr>
            <td>{{ member.name }}</td>
            <td>
              {% for link in member.department_links.all %}
                {{ link.department.name }}{% if not forloop.last %}, {% endif %}
              {% empty %}
                -
              {% endfor %}
            </td>
            <td>{{ member.created_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a class="btn-inline" href="{% url 'member_settings' %}?edit={{ member.id }}">編集</a>
              <form method="post" action="{% url 'member_delete' member.id %}" style="display:inline;" onsubmit="return confirm('このメンバーを削除します。よろしいですか？');">
                {% csrf_token %}
                <button class="btn-inline btn-danger" type="submit">削除</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="muted">まだメンバーは登録されていません。</p>
      {% endif %}
    </article>
  </section>
</div>
{% endblock %}
