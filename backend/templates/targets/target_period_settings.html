{% extends "base.html" %}

{% block title %}路程設定 | 管理者ページ{% endblock %}

{% block content %}
<div class="container">
  <header class="topbar">
    <div>
      <strong>路程設定</strong>
      <div class="muted" style="color: #e1f1f5;">路程目標の入力と状態管理を行います。</div>
    </div>
    <nav>
      <a href="{% url 'target_index' %}">目標ダッシュボード</a>
      <a href="{% url 'target_month_settings' %}">月目標設定</a>
      <a href="{% url 'logout' %}" class="logout-link">ログアウト</a>
    </nav>
  </header>

  <section class="card" style="margin-top: 16px;">
    <h3>路程期間・状態</h3>
    {% if form_error %}
    <div class="error-text" style="margin: 10px 0;">{{ form_error }}</div>
    {% endif %}
    {% if period_saved %}
    <div class="notice" style="margin: 10px 0;">路程を保存しました。</div>
    {% endif %}
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_period" />
      <input type="hidden" name="edit_period_id" value="{{ form_edit_period_id }}" />
      <input type="hidden" name="force_overwrite" value="0" />
      <input type="hidden" name="overwrite_period_id" value="" />
      <div class="grid grid-2">
        <div>
          <label>対象年月</label>
          <input type="month" name="period_month" value="{{ form_month }}" required />
        </div>
        <div>
          <label>路程回次</label>
          <select name="period_sequence" required>
            {% for value in period_sequence_options %}
            <option value="{{ value }}" {% if form_sequence == value %}selected{% endif %}>第{{ value }}次</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>状態（自動）</label>
          <div class="badge" style="margin-top: 8px; display: inline-block;">{{ form_status }}</div>
        </div>
      </div>
      <div class="grid grid-2">
        <div>
          <label>開始日</label>
          <input type="date" name="start_date" value="{{ form_start_date }}" required />
        </div>
        <div>
          <label>終了日</label>
          <input type="date" name="end_date" value="{{ form_end_date }}" required />
        </div>
      </div>
      <div style="margin-top: 10px;"><button type="submit">路程を保存</button></div>
    </form>
  </section>

  <section class="card" style="margin-top: 16px;">
    <h3>路程目標入力</h3>
    {% if target_saved %}
    <div class="notice" style="margin: 10px 0;">路程目標を保存しました。</div>
    {% endif %}
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_period_targets" />
      <div class="grid grid-2">
        <div>
          <label>対象路程</label>
          <select name="selected_period_id" required>
            <option value="">選択してください</option>
            {% for option in period_options %}
            <option value="{{ option.id }}" {% if selected_period and selected_period.id == option.id %}selected{% endif %}>
              {{ option.label }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <span class="badge" style="margin-top: 24px; display: inline-block;">{{ selected_period_label }}</span>
        </div>
      </div>

      {% for row in rows %}
      <div style="margin-top: 12px; padding: 10px; border: 1px solid #d4e2ea; border-radius: 8px;">
        <strong>{{ row.label }}</strong>
        <div class="grid grid-2" style="margin-top: 8px;">
          {% for metric in row.metrics %}
          <div>
            <label>{{ metric.label }}</label>
            <input type="text" inputmode="numeric" name="{{ metric.input_name }}" value="{{ metric.value }}" />
            <div class="muted">{{ metric.unit }}</div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}

      <div style="margin-top: 12px;"><button type="submit">路程目標を保存</button></div>
    </form>
  </section>

  <section class="card" style="margin-top: 16px;">
    <h3>作成済み路程目標一覧</h3>
    {% if period_deleted %}
    <div class="note" style="margin: 10px 0;">路程を削除しました。</div>
    {% endif %}
    {% if history_rows %}
    <table>
      <thead>
        <tr><th>路程名</th><th>期間</th><th>状態</th><th>操作</th></tr>
      </thead>
      <tbody>
        {% for row in history_rows %}
        <tr>
          <td>{{ row.name }}</td>
          <td>{{ row.range_label }}</td>
          <td>{{ row.status }}</td>
          <td class="target-op-cell">
            <a class="btn-inline" href="{% url 'target_period_settings' %}?period={{ row.id }}">表示</a>
            <form method="post" class="target-delete-form" onsubmit="return confirm('この路程を削除します。よろしいですか？');">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete_period" />
              <input type="hidden" name="delete_period_id" value="{{ row.id }}" />
              <button type="submit" class="btn-inline btn-danger">削除</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="muted">作成済みの路程目標はありません。</p>
    {% endif %}
  </section>
</div>
{{ history_rows|json_script:"period-history-data" }}
<script>
  (function () {
    function formatAmountValue(value) {
      const digits = String(value || "").replace(/[^\d]/g, "");
      if (!digits) return "";
      return Number(digits).toLocaleString("en-US");
    }

    function bindAmountInput(input) {
      if (!input || input.dataset.commaBound === "1") return;
      input.dataset.commaBound = "1";
      input.addEventListener("input", function () {
        input.value = formatAmountValue(input.value);
      });
      input.addEventListener("blur", function () {
        input.value = formatAmountValue(input.value || "0");
      });
      input.value = formatAmountValue(input.value || "0");
    }

    function bindForm(form) {
      form.querySelectorAll("input[name^='metric_']").forEach(bindAmountInput);
      form.addEventListener("submit", function () {
        form.querySelectorAll("input[name^='metric_']").forEach(function (input) {
          input.value = String(input.value || "").replace(/,/g, "");
        });
      });
    }

    document.querySelectorAll("form").forEach(function (form) {
      if (form.querySelector("input[name='action'][value='save_period_targets']")) {
        bindForm(form);
      }
    });

    const savePeriodForm = document.querySelector("form input[name='action'][value='save_period']")?.form;
    const historyEl = document.getElementById("period-history-data");
    if (!savePeriodForm || !historyEl) return;

    let periodHistory = [];
    try {
      periodHistory = JSON.parse(historyEl.textContent || "[]");
    } catch (e) {
      periodHistory = [];
    }

    function overlaps(startA, endA, startB, endB) {
      return startA <= endB && endA >= startB;
    }

    savePeriodForm.addEventListener("submit", function (event) {
      const editId = (savePeriodForm.querySelector("input[name='edit_period_id']")?.value || "").trim();
      const month = (savePeriodForm.querySelector("input[name='period_month']")?.value || "").trim();
      const sequence = (savePeriodForm.querySelector("select[name='period_sequence']")?.value || "").trim();
      const startDate = (savePeriodForm.querySelector("input[name='start_date']")?.value || "").trim();
      const endDate = (savePeriodForm.querySelector("input[name='end_date']")?.value || "").trim();
      const forceInput = savePeriodForm.querySelector("input[name='force_overwrite']");
      const overwriteInput = savePeriodForm.querySelector("input[name='overwrite_period_id']");

      if (!month || !sequence || !startDate || !endDate || !forceInput || !overwriteInput) return;

      forceInput.value = "0";
      overwriteInput.value = "";

      const year = Number(month.slice(0, 4));
      const monthNumber = Number(month.slice(5, 7));
      const generatedName = year + "年度" + monthNumber + "月 第" + sequence + "次路程";
      const monthParam = month;
      const currentId = editId ? Number(editId) : null;

      const duplicate = periodHistory.find(function (row) {
        if (currentId && Number(row.id) === currentId) return false;
        return row.month_param === monthParam && row.name === generatedName;
      });

      if (duplicate) {
        const ok = window.confirm("すでに同じ名前の路程が存在します。上書きしますか？");
        if (!ok) {
          event.preventDefault();
          return;
        }
        forceInput.value = "1";
        overwriteInput.value = String(duplicate.id);
        return;
      }

      const overlapped = periodHistory.find(function (row) {
        if (currentId && Number(row.id) === currentId) return false;
        return overlaps(startDate, endDate, row.start_date, row.end_date);
      });

      if (overlapped) {
        const ok = window.confirm("指定の期間と重複する期間の路程が既に存在します。上書きしますか？");
        if (!ok) {
          event.preventDefault();
          return;
        }
        forceInput.value = "1";
        overwriteInput.value = String(overlapped.id);
      }
    });
  })();
</script>
{% endblock %}
