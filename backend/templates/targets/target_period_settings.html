{% extends "base.html" %}

{% block title %}霍ｯ遞玖ｨｭ螳・| 邂｡逅・・・繝ｼ繧ｸ{% endblock %}

{% block content %}
<div class="container">
  <header class="topbar">
    <div>
      <strong>霍ｯ遞玖ｨｭ螳・/strong>
      <div class="muted" style="color: #e1f1f5;">霍ｯ遞狗岼讓吶・蜈･蜉帙→迥ｶ諷狗ｮ｡逅・ｒ陦後＞縺ｾ縺吶・/div>
    </div>
    <nav>
      <a href="{% url 'target_index' %}">逶ｮ讓吶ム繝・す繝･繝懊・繝・/a>
      <a href="{% url 'target_month_settings' %}">譛育岼讓呵ｨｭ螳・/a>
      <a href="{% url 'logout' %}" class="logout-link">繝ｭ繧ｰ繧｢繧ｦ繝・/a>
    </nav>
  </header>

  <section class="card" style="margin-top: 16px;">
    <h3>霍ｯ遞狗匳骭ｲ繝ｻ譖ｴ譁ｰ</h3>
    {% if form_error %}
    <div class="error-text" style="margin: 10px 0;">{{ form_error }}</div>
    {% endif %}
    {% if period_saved %}
    <div class="notice" style="margin: 10px 0;">霍ｯ遞九ｒ菫晏ｭ倥＠縺ｾ縺励◆縲・/div>
    {% endif %}
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_period" />
      <input type="hidden" name="edit_period_id" value="{{ form_edit_period_id }}" />
      <div class="grid grid-2">
        <div>
          <label>対象年月</label>
          <input type="month" name="period_month" value="{{ form_month }}" required />
        </div>
        <div>
          <label>路程回次</label>
          <select name="period_sequence" required>
            {% for value in period_sequence_options %}
            <option value="{{ value }}" {% if form_sequence == value %}selected{% endif %}>第{{ value }}次</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>状態（自動）</label>
          <div class="badge" style="margin-top: 8px; display: inline-block;">{{ form_status }}</div>
        </div>
      </div>
      <div class="grid grid-2">
        <div>
          <label>開始日</label>
          <input type="date" name="start_date" value="{{ form_start_date }}" required />
        </div>
        <div>
          <label>終了日</label>
          <input type="date" name="end_date" value="{{ form_end_date }}" required />
        </div>
      </div>`r`n      <div style="margin-top: 10px;"><button type="submit">霍ｯ遞九ｒ菫晏ｭ・/button></div>
    </form>
  </section>

  <section class="card" style="margin-top: 16px;">
    <h3>霍ｯ遞狗岼讓吝・蜉・/h3>
    {% if target_saved %}
    <div class="notice" style="margin: 10px 0;">霍ｯ遞狗岼讓吶ｒ菫晏ｭ倥＠縺ｾ縺励◆縲・/div>
    {% endif %}
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_period_targets" />
      <div class="grid grid-2">
        <div>
          <label>蟇ｾ雎｡霍ｯ遞・/label>
          <select name="selected_period_id" required>
            <option value="">驕ｸ謚槭＠縺ｦ縺上□縺輔＞</option>
            {% for option in period_options %}
            <option value="{{ option.id }}" {% if selected_period and selected_period.id == option.id %}selected{% endif %}>
              {{ option.label }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <span class="badge" style="margin-top: 24px; display: inline-block;">{{ selected_period_label }}</span>
        </div>
      </div>

      {% for row in rows %}
      <div style="margin-top: 12px; padding: 10px; border: 1px solid #d4e2ea; border-radius: 8px;">
        <strong>{{ row.label }}</strong>
        <div class="grid grid-2" style="margin-top: 8px;">
          {% for metric in row.metrics %}
          <div>
            <label>{{ metric.label }}</label>
            <input type="number" min="0" name="{{ metric.input_name }}" value="{{ metric.value }}" />
            <div class="muted">{{ metric.unit }}</div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}

      <div style="margin-top: 12px;"><button type="submit">霍ｯ遞狗岼讓吶ｒ菫晏ｭ・/button></div>
    </form>
  </section>

  <section class="card" style="margin-top: 16px;">
    <h3>菴懈・貂医∩霍ｯ遞狗岼讓吩ｸ隕ｧ</h3>
    {% if period_deleted %}
    <div class="note" style="margin: 10px 0;">霍ｯ遞九ｒ蜑企勁縺励∪縺励◆縲・/div>
    {% endif %}
    {% if history_rows %}
    <table>
      <thead>
        <tr><th>霍ｯ遞句錐</th><th>譛滄俣</th><th>迥ｶ諷・/th><th>謫堺ｽ・/th></tr>
      </thead>
      <tbody>
        {% for row in history_rows %}
        <tr>
          <td>{{ row.name }}</td>
          <td>{{ row.range_label }}</td>
          <td>{{ row.status }}</td>
          <td class="target-op-cell">
            <a class="btn-inline" href="{% url 'target_period_settings' %}?period={{ row.id }}">陦ｨ遉ｺ</a>
            <form method="post" class="target-delete-form" onsubmit="return confirm('縺薙・霍ｯ遞九ｒ蜑企勁縺励∪縺吶ゅｈ繧阪＠縺・〒縺吶°・・);">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete_period" />
              <input type="hidden" name="delete_period_id" value="{{ row.id }}" />
              <button type="submit" class="btn-inline btn-danger">蜑企勁</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="muted">菴懈・貂医∩縺ｮ霍ｯ遞狗岼讓吶・縺ゅｊ縺ｾ縺帙ｓ縲・/p>
    {% endif %}
  </section>
</div>
{% endblock %}


